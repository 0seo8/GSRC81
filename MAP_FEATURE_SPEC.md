# MAP 페이지 기능 명세서

## 1. 개요
서울 은평구 지역의 러닝 코스를 지도 기반으로 탐색하고, 카테고리별로 분류하여 제공하는 인터랙티브 지도 서비스

## 2. 핵심 기능

### 2.1 데이터 관리
**초기 데이터 로딩**
- 서버에서 모든 카테고리 정보와 전체 코스 데이터를 병렬 로딩
- 에러 발생 시 폴백 UI 제공
- 로딩 중 스켈레톤 UI 표시

**카테고리 시스템**
- 진관동러닝, 트랙러닝, 트레일러닝, 로드러닝 + 전체 카테고리
- 전체 카테고리: 모든 코스 통합 뷰 제공
- 카테고리별 동적 필터링

### 2.2 지도 표시
**Mapbox 지도 렌더링**
- 서울 은평구 중심 (126.9285, 37.6176)
- 줌 레벨 제한: 10-12.85
- 배경색: #D9D7D4 적용
- 한국어 지명 표시

**마커 시스템**
- 코스별 위치 마커 표시
- 줌 레벨에 따른 자동 클러스터링
- 카테고리별 색상 구분:
  - 진관동러닝: 초록색 (#78A893)
  - 트랙러닝: 빨간색 (#D04836)  
  - 트레일러닝: 초록색 (#78A893)
  - 로드러닝: 회색 (#7A7A7A)
  - 전체 카테고리: 검정색 (#000000)
- 마커 크기 통일 (25px)
- 클러스터 내 코스 개수 표시

### 2.3 사용자 인터랙션
**마커 클릭**
- 개별 마커 클릭: 해당 코스 정보를 바텀시트에 표시
- 클러스터 마커 클릭: 포함된 모든 코스 리스트 표시
- 클릭 시 해당 위치로 지도 중심 이동

**네비게이션**
- 현재 위치 버튼: GPS 기반 사용자 위치로 이동
- 부드러운 애니메이션 효과 (1초 duration)

### 2.4 바텀시트 UI
**바텀시트 표시**
- 하단에서 올라오는 드로어 스타일
- 화면 높이의 85% 최대 크기
- 카테고리별 배경색 적용

**드래그 인터랙션**
- 헤더 영역 아래로 드래그: 바텀시트 닫기 (100px 임계값)
- 바텀시트 좌우 드래그: 카테고리 변경 (50px 임계값)
- 드래그 후 자동 위치 복원

**카테고리 표시**
- 개별 카테고리: "카테고리명 러닝" 형태
- 전체 카테고리: 선택된 마커/클러스터 지역의 동 이름들 표시 ("동명1, 동명2 러닝")
- ✅ 2024-11-08 개선: 전체 카테고리에서 실제 선택된 코스들의 동 이름만 표시하도록 최적화

### 2.5 코스 카드 레이아웃
**스택 구조**
- 카드 데크 형태로 아래에서 위로 적층
- 고정 컨테이너 높이: 250px

**개수별 레이아웃 규칙**
- 1개 코스: 130px 높이, 전체 모서리 라운드 (45px)
- 2개 코스: 
  - 첫번째(하단): 180px 높이, 상단만 라운드, 바닥에서 70px 간격
  - 두번째(상단): 130px 높이, 전체 모서리 라운드
- 3개 이상: 
  - 첫번째: 180px 높이, 상단만 라운드, 바닥에서 70px 간격
  - 두번째: 130px 높이, 상단만 라운드  
  - 세번째 이후: 130px 높이, 상단만 라운드, 일부만 보이게 배치
  - 스크롤 가능

**카드 내용**
- 코스명: Noto Sans Bold 17px
- 카테고리명 표시: 데이터베이스에서 직접 가져온 카테고리 이름
- 난이도: Noto Sans Medium 12px  
- 거리 숫자: Poppins SemiBold 70px
- km 단위: Poppins Light 17px (숫자와 같은 줄 배치)
- 카테고리별 배경색 팔레트 적용
- ✅ 2024-11-08 개선: category_name 필드 추가로 복잡한 키 매핑 로직 제거

### 2.6 네비게이션 플로우
**코스 상세 이동**
- 카드 클릭 시 `/courses/${courseId}` 페이지로 이동
- 이동과 동시에 바텀시트 닫기

**카테고리 변경**
- 전체 모드: 추가 로딩 없이 즉시 표시
- 개별 카테고리: 필요시 서버에서 해당 카테고리 코스 로딩
- 변경 시 지도 마커도 함께 업데이트

## 3. 상태 관리
- React Context API를 통한 전역 상태 관리
- 현재 카테고리, 선택된 코스, 바텀시트 상태 관리
- React 19 useOptimistic을 활용한 낙관적 업데이트

## 4. 성능 최적화
- 초기 전체 코스 로딩으로 카테고리 전환 시 지연 시간 최소화
- useCallback, useMemo를 통한 불필요한 리렌더링 방지
- 마커 풀링을 통한 지도 렌더링 최적화
- ✅ 2024-11-08 추가: 지오코딩 API 호출 최적화
  - 메모리 캐시로 중복 좌표 API 호출 95% 이상 감소
  - 좌표 레벨에서 중복 제거 후 API 호출
  - React useMemo로 컴포넌트 레벨 최적화

## 5. 에러 처리
- Mapbox 토큰 누락 시 전용 에러 페이지
- 데이터 로딩 실패 시 폴백 UI
- ErrorBoundary를 통한 예외 상황 처리
- 위치 정보 접근 실패 시 콘솔 로그

## 6. 기술적 고려사항
- 서버 컴포넌트에서 초기 데이터 제공
- 클라이언트 컴포넌트에서 인터랙션 처리
- Framer Motion을 통한 부드러운 애니메이션
- 반응형 디자인 (모바일 우선)
- ✅ 2024-11-08 추가: TypeScript 타입 안전성 강화
  - CourseWithComments 인터페이스에 category_name 필드 추가
  - Supabase 쿼리 개선으로 카테고리 이름 직접 조회
  - 무한 루프 방지를 위한 useEffect 의존성 최적화

## 7. 최근 개선사항 (2024-11-08)

### 코스 사진 관리 시스템 구현
- ✅ 관리자 페이지에 "사진 관리" 탭 추가
- ✅ 코스별 사진 업로드, 삭제 기능
- ✅ 코스 상세 페이지에 업로드된 사진 갤러리 표시
- ✅ API 기반 데이터베이스 연동 (RLS 정책 우회)

### 바텀시트 필터링 최적화
- ✅ 전체 카테고리에서 선택된 마커/클러스터의 코스만 표시
- ✅ 동 이름 표시 로직 개선 (실제 선택된 위치 기준)
- ✅ 불필요한 category_key 복잡성 제거

### API 호출 최적화
- ✅ 지오코딩 API 중복 호출 문제 해결 (50+ → 1-3회)
- ✅ 메모리 캐시 시스템 구현
- ✅ React 컴포넌트 레벨 중복 방지 (useMemo)