í˜„ìž¬ ìƒí™©ì„ ì •ë¦¬í•´ì¤„ê²Œ. ë„ˆê°€ ì²˜ìŒ ë§í–ˆë˜

ì¢‹ì•„ìš”! ì•„ëž˜ëŠ” **PDF ê¸°ë°˜ ìŠ¤í‚¤ë§ˆ + ëŒ“ê¸€ ìˆ˜ì •/ì‚­ì œ + ëŒ“ê¸€ ì‚¬ì§„ ì—…ë¡œë“œ**ê¹Œì§€ ëª¨ë‘ ë°˜ì˜í•œ **ì™„ì „ DDL íŒŒì¼**ìž…ë‹ˆë‹¤.
(Supabase/PostgreSQL ê¸°ì¤€, gen_random_uuid() ì‚¬ìš©)

> íŒŒì¼ëª… ì œì•ˆ: GSRC81_SCHEMA_WITH_COMMENTS_PHOTOS.sql


sql
-- ====================================================================
-- GSRC81 MAPS â€” PDF ê¸°ë°˜ ìµœì¢… ìŠ¤í‚¤ë§ˆ (+ ëŒ“ê¸€ ìˆ˜ì •/ì‚­ì œ + ì‚¬ì§„ ì²¨ë¶€)
-- ====================================================================
-- DB: PostgreSQL / Supabase
-- ìš”êµ¬ì‚¬í•­ ìš”ì•½:
--  - ì½”ìŠ¤/ì¹´í…Œê³ ë¦¬
--  - GPX ë‹¨ì¼ ì†ŒìŠ¤(JSONB, points[].dist í¬í•¨ â†’ 1km ë§ˆì»¤ìš©)
--  - ë¹„í–‰ ì¤‘ ë…¸íŠ¸(ì§€ë„ ì£¼ì„)
--  - ì‚¬ìš©ìž ëŒ“ê¸€(ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ê¸°ë°˜, ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥)
--  - ëŒ“ê¸€ ì‚¬ì§„ ì²¨ë¶€(1:N)
--  - ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì •ë³´ ì €ìž¥(ê°„ë‹¨)
--  - ê´€ë¦¬ìž ê³„ì •
--  - (ì„ íƒ) RLS ì •ì±… ìƒ˜í”Œ í¬í•¨
-- ====================================================================

BEGIN;

-- --------------------------------------------------------------------
-- 0) Extensions (SupabaseëŠ” ê¸°ë³¸ ì œê³µí•˜ëŠ” ê²½ìš°ê°€ ë§Žì§€ë§Œ ì•ˆì „í•˜ê²Œ)
-- --------------------------------------------------------------------
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- --------------------------------------------------------------------
-- 1) ì¹´í…Œê³ ë¦¬ (ì§„ê´€/íŠ¸ëž™/íŠ¸ë ˆì¼/ë¡œë“œ)
-- --------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.course_categories (
  id           uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  key          varchar UNIQUE NOT NULL,      -- 'jingwan'|'track'|'trail'|'road'
  name         varchar NOT NULL,             -- í‘œì‹œëª…
  sort_order   int DEFAULT 0,
  is_active    boolean DEFAULT true,
  created_at   timestamptz DEFAULT now(),
  updated_at   timestamptz DEFAULT now()
);

-- ê¸°ë³¸ Seed (í•„ìš”ì‹œ)
INSERT INTO public.course_categories (key, name, sort_order)
VALUES
  ('jingwan', 'ì§„ê´€ë™ëŸ¬ë‹', 1),
  ('track', 'íŠ¸ëž™ëŸ¬ë‹', 2),
  ('trail', 'íŠ¸ë ˆì¼ëŸ¬ë‹', 3),
  ('road', 'ë¡œë“œëŸ¬ë‹', 4)
ON CONFLICT (key) DO NOTHING;

-- --------------------------------------------------------------------
-- 2) ì½”ìŠ¤ (ë©”ì¸ ë°ì´í„° + GPX ë‹¨ì¼ì†ŒìŠ¤)
-- --------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.courses (
  id                  uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  category_id         uuid REFERENCES public.course_categories(id) ON DELETE SET NULL,

  title               varchar NOT NULL,        -- ì˜ˆ: êµ¬íŒŒë°œì²œ ì •ê¸°ëŸ°
  description         text,                    -- ì˜ˆ: ë¡œë“œëŸ¬ë‹ì½”ìŠ¤
  cover_image_url     text,                    -- ì¸ë„¤ì¼

  difficulty          varchar NOT NULL DEFAULT 'medium'
                     CHECK (difficulty IN ('easy','medium','hard')),
  distance_km         numeric NOT NULL,        -- km ë‹¨ìœ„
  avg_time_min        integer,                 -- ìƒì„¸ í—¤ë”(ì‹œê°„)
  elevation_gain      integer,                 -- ìƒì„¸ í—¤ë”(ê³ ë„)

  start_latitude      double precision,
  start_longitude     double precision,
  end_latitude        double precision,
  end_longitude       double precision,

  -- GPX ë‹¨ì¼ì†ŒìŠ¤(JSONB). points[].{lat,lng,ele,dist}, stats.{totalDistance,elevationGain}
  gpx_data            jsonb NOT NULL,

  view_count          int    DEFAULT 0,
  like_count          int    DEFAULT 0,

  is_active           boolean DEFAULT true,
  created_at          timestamptz DEFAULT now(),
  updated_at          timestamptz DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_courses_category      ON public.courses(category_id);
CREATE INDEX IF NOT EXISTS idx_courses_active        ON public.courses(is_active);
CREATE INDEX IF NOT EXISTS idx_courses_gpxdata_gin   ON public.courses USING GIN (gpx_data);

-- --------------------------------------------------------------------
-- 3) ë¹„í–‰ ì¤‘ ë…¸íŠ¸ (ì§€ë„ ì¢Œí‘œ ê¸°ë°˜ ì£¼ì„)
-- --------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.course_location_notes (
  id                     uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  course_id              uuid NOT NULL REFERENCES public.courses(id) ON DELETE CASCADE,

  latitude               double precision NOT NULL,
  longitude              double precision NOT NULL,
  title                  varchar NOT NULL,
  content                text,
  memo_type              varchar DEFAULT 'general'
                         CHECK (memo_type IN ('general','warning','highlight','rest')),
  show_during_animation  boolean DEFAULT true,

  created_by             varchar,
  created_at             timestamptz DEFAULT now(),
  updated_at             timestamptz DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_notes_course ON public.course_location_notes(course_id);

-- --------------------------------------------------------------------
-- 4) ì‚¬ìš©ìž ëŒ“ê¸€ (ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ê¸°ë°˜ ìˆ˜ì •/ì‚­ì œ + ë©”íƒ€)
-- --------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.course_comments (
  id               uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  course_id        uuid NOT NULL REFERENCES public.courses(id) ON DELETE CASCADE,

  -- í‘œì‹œìš© ìŠ¤ëƒ…ìƒ· (ë‹‰ë„¤ìž„/ì•„ë°”íƒ€)
  author_nickname  varchar NOT NULL,
  avatar_url       text,

  -- ì†Œìœ ê¶Œ íŒì • í‚¤ (ì¹´ì¹´ì˜¤ ì‹ë³„ìž ë˜ëŠ” ë‚´ë¶€ ì‚¬ìš©ìž í‚¤)
  author_user_key  text,  -- ì˜ˆ: kakao_user_id (NULL í—ˆìš© â†’ ë¹„ë¡œê·¸ì¸/ê²ŒìŠ¤íŠ¸ í—ˆìš© ì‹œ)

  message          text NOT NULL,

  -- ì¢‹ì•„ìš” ì§‘ê³„(ë‹¨ìˆœ ì¹´ìš´íŠ¸; ê°œë³„ ì‚¬ìš©ìž ížˆìŠ¤í† ë¦¬ëŠ” ë²”ìœ„ ë°–)
  likes_count      int DEFAULT 0,

  -- ìˆ˜ì •/ì‚­ì œ ë©”íƒ€
  edited_at        timestamptz,
  edit_count       int DEFAULT 0,
  is_deleted       boolean DEFAULT false,
  deleted_at       timestamptz,
  deleted_by       text,                    -- ë³¸ì¸ or 'admin:username'

  created_at       timestamptz DEFAULT now(),
  updated_at       timestamptz DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_comments_course       ON public.course_comments(course_id);
CREATE INDEX IF NOT EXISTS idx_comments_created      ON public.course_comments(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_comments_user_key     ON public.course_comments(author_user_key);
CREATE INDEX IF NOT EXISTS idx_comments_not_deleted  ON public.course_comments(course_id, is_deleted, created_at DESC);

-- --------------------------------------------------------------------
-- 5) ëŒ“ê¸€ ì‚¬ì§„ (1:N)
-- --------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.course_comment_photos (
  id          uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  comment_id  uuid NOT NULL REFERENCES public.course_comments(id) ON DELETE CASCADE,
  file_url    text NOT NULL,         -- Supabase Storage URL (public ë˜ëŠ” signed)
  width       int,
  height      int,
  sort_order  int DEFAULT 0,
  created_at  timestamptz DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_comment_photos_comment ON public.course_comment_photos(comment_id);
CREATE INDEX IF NOT EXISTS idx_comment_photos_sort    ON public.course_comment_photos(comment_id, sort_order);

-- --------------------------------------------------------------------
-- 6) ì ‘ê·¼/ë¡œê·¸ì¸ (ì¹´ì¹´ì˜¤ + ì ‘ê·¼ì½”ë“œ)
-- --------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.access_links (
  id               uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  access_code      varchar UNIQUE,     -- ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ê¸°ë°˜ ì ‘ê·¼ (ì˜µì…˜)
  kakao_user_id    varchar,            -- ì¹´ì¹´ì˜¤ ì‹ë³„ìž
  kakao_nickname   varchar,
  kakao_profile_url text,
  is_active        boolean DEFAULT true,
  created_at       timestamptz DEFAULT now(),
  updated_at       timestamptz DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_access_active ON public.access_links(is_active);
CREATE INDEX IF NOT EXISTS idx_access_kakao  ON public.access_links(kakao_user_id);

-- --------------------------------------------------------------------
-- 7) ê´€ë¦¬ìž ê³„ì •
-- --------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.admin (
  id             uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  username       varchar UNIQUE NOT NULL,
  password_hash  varchar NOT NULL,
  role           varchar NOT NULL DEFAULT 'editor' CHECK (role IN ('super','editor')),
  created_at     timestamptz DEFAULT now(),
  updated_at     timestamptz DEFAULT now()
);

-- ====================================================================
-- (ì„ íƒ) RLS ì •ì±… ìƒ˜í”Œ â€” Supabase ê¶Œìž¥
--  - ì „ì œ: JWTì— kakao_user_id í´ë ˆìž„ì„ ì£¼ìž…í•´ ì‚¬ìš©
--  - ì—†ì„ ê²½ìš°, ì •ì±…ì˜ current_setting í‚¤ë¥¼ í”„ë¡œì íŠ¸ì— ë§žì¶° ìˆ˜ì • í•„ìš”
-- ====================================================================

-- --------------------------------------------------
-- ê³µê°œ ì¡°íšŒëŠ” í—ˆìš©(ì‚­ì œëœ ëŒ“ê¸€ì€ ìˆ¨ê¹€)
-- --------------------------------------------------
ALTER TABLE public.course_comments ENABLE ROW LEVEL SECURITY;
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_policies
    WHERE schemaname='public' AND tablename='course_comments' AND policyname='comments_select_not_deleted'
  ) THEN
    CREATE POLICY comments_select_not_deleted
      ON public.course_comments
      FOR SELECT
      USING (is_deleted = false OR (author_user_key IS NOT NULL AND author_user_key = current_setting('request.jwt.claim.kakao_user_id', true)));
  END IF;
END$$;

-- ìž‘ì„±(INSERT): ë¡œê·¸ì¸ ì‚¬ìš©ìžë§Œ, ë³¸ì¸ í‚¤ë¡œ ìž‘ì„±
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_policies
    WHERE schemaname='public' AND tablename='course_comments' AND policyname='comments_insert_self'
  ) THEN
    CREATE POLICY comments_insert_self
      ON public.course_comments
      FOR INSERT
      WITH CHECK (
        current_setting('request.jwt.claim.kakao_user_id', true) IS NOT NULL
        AND author_user_key = current_setting('request.jwt.claim.kakao_user_id', true)
      );
  END IF;
END$$;

-- ìˆ˜ì •/ì‚­ì œ(UPDATE/DELETE): ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ìž
--  - ê´€ë¦¬ìžëŠ” ë³„ë„ RPC/ì„œë²„ì—ì„œ role í´ë ˆìž„ì„ ë„£ì–´ ì‹¤í–‰í•˜ëŠ” íŒ¨í„´ ê¶Œìž¥
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_policies
    WHERE schemaname='public' AND tablename='course_comments' AND policyname='comments_update_owner_or_admin'
  ) THEN
    CREATE POLICY comments_update_owner_or_admin
      ON public.course_comments
      FOR UPDATE
      USING (
        (author_user_key = current_setting('request.jwt.claim.kakao_user_id', true))
        OR (current_setting('request.jwt.claim.role', true) = 'admin')
      )
      WITH CHECK (
        (author_user_key = current_setting('request.jwt.claim.kakao_user_id', true))
        OR (current_setting('request.jwt.claim.role', true) = 'admin')
      );
  END IF;
END$$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_policies
    WHERE schemaname='public' AND tablename='course_comments' AND policyname='comments_delete_owner_or_admin'
  ) THEN
    CREATE POLICY comments_delete_owner_or_admin
      ON public.course_comments
      FOR DELETE
      USING (
        (author_user_key = current_setting('request.jwt.claim.kakao_user_id', true))
        OR (current_setting('request.jwt.claim.role', true) = 'admin')
      );
  END IF;
END$$;

-- ëŒ“ê¸€ ì‚¬ì§„ RLS
ALTER TABLE public.course_comment_photos ENABLE ROW LEVEL SECURITY;

-- ì¡°íšŒ: ìƒìœ„ ëŒ“ê¸€ì´ ë³´ì´ëŠ” ì¡°ê±´ê³¼ ë™ì¼í•˜ê²Œ í—ˆìš©(ê°„ë‹¨ ë²„ì „)
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_policies
    WHERE schemaname='public' AND tablename='course_comment_photos' AND policyname='comment_photos_select_public'
  ) THEN
    CREATE POLICY comment_photos_select_public
      ON public.course_comment_photos
      FOR SELECT
      USING (
        EXISTS (
          SELECT 1 FROM public.course_comments c
          WHERE c.id = course_comment_photos.comment_id
            AND (c.is_deleted = false OR (c.author_user_key IS NOT NULL AND c.author_user_key = current_setting('request.jwt.claim.kakao_user_id', true)))
        )
      );
  END IF;
END$$;

-- ì‚½ìž…/ì‚­ì œ: ìƒìœ„ ëŒ“ê¸€ì˜ ìž‘ì„±ìž(ë˜ëŠ” ê´€ë¦¬ìž)ë§Œ
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_policies
    WHERE schemaname='public' AND tablename='course_comment_photos' AND policyname='comment_photos_ins_del_owner_or_admin'
  ) THEN
    CREATE POLICY comment_photos_ins_del_owner_or_admin
      ON public.course_comment_photos
      FOR ALL
      USING (
        EXISTS (
          SELECT 1 FROM public.course_comments c
          WHERE c.id = course_comment_photos.comment_id
            AND (
              c.author_user_key = current_setting('request.jwt.claim.kakao_user_id', true)
              OR current_setting('request.jwt.claim.role', true) = 'admin'
            )
        )
      )
      WITH CHECK (
        EXISTS (
          SELECT 1 FROM public.course_comments c
          WHERE c.id = course_comment_photos.comment_id
            AND (
              c.author_user_key = current_setting('request.jwt.claim.kakao_user_id', true)
              OR current_setting('request.jwt.claim.role', true) = 'admin'
            )
        )
      );
  END IF;
END$$;

-- (ì„ íƒ) ê³µê°œ ì¡°íšŒ í—ˆìš©ì„ ìœ„í•œ ê¸°ë³¸ anon ê¶Œí•œ(í”„ë¡œì íŠ¸ ì •ì±…ì— ë§žê²Œ ì¡°ì ˆ)
-- REVOKE ALL ON public.course_comments FROM PUBLIC;
-- REVOKE ALL ON public.course_comment_photos FROM PUBLIC;

COMMIT;

-- ====================================================================
-- ì°¸ê³ :
-- - Kakao ë¡œê·¸ì¸ ì‹œ ì„œë²„(Edge Function ë“±)ì—ì„œ JWTì—
--   `kakao_user_id`ë¥¼ custom claimìœ¼ë¡œ ì£¼ìž…í•˜ë©´ ìœ„ ì •ì±…ì´ ë™ìž‘í•©ë‹ˆë‹¤.
-- - Storage ë²„í‚·(`comment-photos`)ì€ ì •ì±…ì„ ë³„ë„ë¡œ êµ¬ì„±í•˜ê³ 
--   ì—…ë¡œë“œëŠ” signed URL ë°œê¸‰ â†’ í´ë¼ì´ì–¸íŠ¸ ì—…ë¡œë“œ â†’ file_url ì €ìž¥ íë¦„ ê¶Œìž¥.
-- - 1km ë§ˆì»¤: gpx_data.points[].dist(ë¯¸í„°) ì‚¬ì „ê³„ì‚° í•„ìˆ˜.
-- ====================================================================


ì´ê±¸ SQLì—ë””í„°ì—ì„œ ì‹¤í–‰í•œ í›„



sql
-- ===============================================================
-- GSRC81 MAPS - Migration from legacy schema to PDF final schema
-- Safe, in-place migration (no data loss); requires pgcrypto ext.
-- ===============================================================
BEGIN;

-- 0) Extensions (usually preinstalled on Supabase)
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 1) Backup current important tables (lightweight snapshot)
CREATE SCHEMA IF NOT EXISTS backup;
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM information_schema.tables
                 WHERE table_schema='backup' AND table_name='courses') THEN
    EXECUTE 'CREATE TABLE backup.courses AS TABLE public.courses';
  END IF;
  IF NOT EXISTS (SELECT 1 FROM information_schema.tables
                 WHERE table_schema='backup' AND table_name='course_comments') THEN
    EXECUTE 'CREATE TABLE backup.course_comments AS TABLE public.course_comments';
  END IF;
  IF NOT EXISTS (SELECT 1 FROM information_schema.tables
                 WHERE table_schema='backup' AND table_name='course_location_notes') THEN
    EXECUTE 'CREATE TABLE backup.course_location_notes AS TABLE public.course_location_notes';
  END IF;
END$$;

-- 2) Categories (for tabs: jingwan/track/trail/road)
CREATE TABLE IF NOT EXISTS public.course_categories (
  id           uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  key          varchar UNIQUE NOT NULL,
  name         varchar NOT NULL,
  sort_order   int DEFAULT 0,
  is_active    boolean DEFAULT true,
  created_at   timestamptz DEFAULT now(),
  updated_at   timestamptz DEFAULT now()
);

-- Seed initial categories if not present
INSERT INTO public.course_categories (key, name, sort_order)
VALUES
  ('jingwan','ì§„ê´€ë™ëŸ¬ë‹',1),
  ('track','íŠ¸ëž™ëŸ¬ë‹',2),
  ('trail','íŠ¸ë ˆì¼ëŸ¬ë‹',3),
  ('road','ë¡œë“œëŸ¬ë‹',4)
ON CONFLICT (key) DO NOTHING;

-- 3) ACCESS: Kakao login fields (keep legacy access_code/password_hash but make optional)
ALTER TABLE public.access_links
  ALTER COLUMN access_code DROP NOT NULL,
  ALTER COLUMN password_hash DROP NOT NULL;

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                   WHERE table_schema='public' AND table_name='access_links' AND column_name='kakao_user_id') THEN
    ALTER TABLE public.access_links
      ADD COLUMN kakao_user_id varchar,
      ADD COLUMN kakao_nickname varchar,
      ADD COLUMN kakao_profile_url text;
  END IF;
END$$;

-- 4) COURSES: bring to final model (non-breaking, additive first)

-- 4.a) Ensure types better for coords (numeric -> double precision)
ALTER TABLE public.courses
  ALTER COLUMN start_latitude  TYPE double precision USING start_latitude::double precision,
  ALTER COLUMN start_longitude TYPE double precision USING start_longitude::double precision;
-- end_lat/long already exist; upgrade types too if present
ALTER TABLE public.courses
  ALTER COLUMN end_latitude    TYPE double precision USING end_latitude::double precision,
  ALTER COLUMN end_longitude   TYPE double precision USING end_longitude::double precision;

-- 4.b) Add missing operational fields
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_schema='public' AND table_name='courses' AND column_name='category_id') THEN
    ALTER TABLE public.courses ADD COLUMN category_id uuid REFERENCES public.course_categories(id) ON DELETE SET NULL;
  END IF;

  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_schema='public' AND table_name='courses' AND column_name='cover_image_url') THEN
    ALTER TABLE public.courses ADD COLUMN cover_image_url text;
  END IF;

  -- like/view/updated_at for cards/stats
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_schema='public' AND table_name='courses' AND column_name='like_count') THEN
    ALTER TABLE public.courses ADD COLUMN like_count int DEFAULT 0;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_schema='public' AND table_name='courses' AND column_name='view_count') THEN
    ALTER TABLE public.courses ADD COLUMN view_count int DEFAULT 0;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_schema='public' AND table_name='courses' AND column_name='updated_at') THEN
    ALTER TABLE public.courses ADD COLUMN updated_at timestamptz DEFAULT now();
  END IF;
END$$;

-- 4.c) Difficulty constraint normalization (keep existing values, enforce set)
-- If invalid values exist, you can map them to 'medium' before adding CHECK.
DO $$
BEGIN
  -- Add temp constraint only if not exists
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint
    WHERE conrelid = 'public.courses'::regclass
      AND conname  = 'courses_difficulty_ck'
  ) THEN
    ALTER TABLE public.courses
      ADD CONSTRAINT courses_difficulty_ck
      CHECK (difficulty IN ('easy','medium','hard'));
  END IF;
END$$;

-- 4.d) gpx_data should be JSONB and used as single source
-- (column exists but can be NULL; set empty default then backfill in app)
ALTER TABLE public.courses
  ALTER COLUMN gpx_data TYPE jsonb USING gpx_data::jsonb,
  ALTER COLUMN gpx_data SET DEFAULT '{}'::jsonb;

-- 4.e) Optional: drop truly unused columns later (commented for now)
-- ALTER TABLE public.courses DROP COLUMN IF EXISTS gpx_url;
-- ALTER TABLE public.courses DROP COLUMN IF EXISTS gpx_coordinates;
-- ALTER TABLE public.courses DROP COLUMN IF EXISTS nearest_station;

-- 4.f) Indexes
CREATE INDEX IF NOT EXISTS idx_courses_category      ON public.courses(category_id);
CREATE INDEX IF NOT EXISTS idx_courses_active        ON public.courses(is_active);
CREATE INDEX IF NOT EXISTS idx_courses_gpxdata_gin   ON public.courses USING GIN (gpx_data);

-- 5) NOTES: align types and keep flags
ALTER TABLE public.course_location_notes
  ALTER COLUMN latitude  TYPE double precision USING latitude::double precision,
  ALTER COLUMN longitude TYPE double precision USING longitude::double precision;

-- 6) COMMENTS: ownership/edit/delete + avatar; plus photos 1:N
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_schema='public' AND table_name='course_comments' AND column_name='avatar_url') THEN
    ALTER TABLE public.course_comments ADD COLUMN avatar_url text;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_schema='public' AND table_name='course_comments' AND column_name='author_user_key') THEN
    ALTER TABLE public.course_comments ADD COLUMN author_user_key text; -- kakao_user_id snapshot
  END IF;
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_schema='public' AND table_name='course_comments' AND column_name='edited_at') THEN
    ALTER TABLE public.course_comments ADD COLUMN edited_at timestamptz;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_schema='public' AND table_name='course_comments' AND column_name='edit_count') THEN
    ALTER TABLE public.course_comments ADD COLUMN edit_count int DEFAULT 0;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_schema='public' AND table_name='course_comments' AND column_name='is_deleted') THEN
    ALTER TABLE public.course_comments ADD COLUMN is_deleted boolean DEFAULT false;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_schema='public' AND table_name='course_comments' AND column_name='deleted_at') THEN
    ALTER TABLE public.course_comments ADD COLUMN deleted_at timestamptz;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_schema='public' AND table_name='course_comments' AND column_name='deleted_by') THEN
    ALTER TABLE public.course_comments ADD COLUMN deleted_by text;
  END IF;
END$$;

-- indexes for comments
CREATE INDEX IF NOT EXISTS idx_comments_course       ON public.course_comments(course_id);
CREATE INDEX IF NOT EXISTS idx_comments_created      ON public.course_comments(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_comments_user_key     ON public.course_comments(author_user_key);
CREATE INDEX IF NOT EXISTS idx_comments_not_deleted  ON public.course_comments(course_id, is_deleted, created_at DESC);

-- comment photos table
CREATE TABLE IF NOT EXISTS public.course_comment_photos (
  id          uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  comment_id  uuid NOT NULL REFERENCES public.course_comments(id) ON DELETE CASCADE,
  file_url    text NOT NULL,
  width       int,
  height      int,
  sort_order  int DEFAULT 0,
  created_at  timestamptz DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_comment_photos_comment ON public.course_comment_photos(comment_id);
CREATE INDEX IF NOT EXISTS idx_comment_photos_sort    ON public.course_comment_photos(comment_id, sort_order);

-- 7) (Optional) Assign default category for existing courses if NULL
UPDATE public.courses
SET category_id = (SELECT id FROM public.course_categories WHERE key='jingwan')
WHERE category_id IS NULL;

-- 8) Legacy tables you can safely drop AFTER app is switched to gpx_data only
-- (Uncomment once confirmed no code path depends on them)
-- DROP TABLE IF EXISTS public.course_points;
-- DROP TABLE IF EXISTS public.courses_backup;
-- DROP TABLE IF EXISTS public.spatial_ref_sys;

COMMIT;

-- ======================
-- Post-migration notes:
-- - Ensure GPX uploader computes points[].dist and stores in courses.gpx_data.
-- - RLS/Policies for comments/photos should be added in a separate policy script
--   once JWT claims contain kakao_user_id and admin role.
-- - Consider removing legacy columns (gpx_url, gpx_coordinates) after code cutover.
-- ======================

ì´ê±¸ ì‹¤í–‰í•˜ë‹ˆ ë°œìƒí–ˆë˜ ì—ëŸ¬ì˜€ì–´
ë‚˜ì˜ ë§:
2025-10-15_gpx_view_safe_patch.sql ëŠ” ì¼ë‹¨ ì‹¤í–‰í–ˆì–´

ê·¸ë ‡ë‹¤ë©´ 

ë„ˆê°€ ì•žì„œ ì •ë¦¬í–ˆë˜ í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì€ (ì•„ëž˜ë‚´ìš©) ìˆ˜ì •í•˜ì§€ ì•Šì•„ë„ ë¼? ìˆ˜ì •í•˜ì§€ ì•Šê³  ðŸ§­ ì´í›„ ì§„í–‰ ìˆœì„œ (ì•ˆì „ ì „í™˜ ê°€ì´ë“œ)

ì•± ì½”ë“œ ì „í™˜

ì¿¼ë¦¬/íƒ€ìž…/íŒŒì„œì—ì„œ courses.gpx_data ëŒ€ì‹  courses.gpx_data_v2 ì‚¬ìš©.

1km ë§ˆì»¤ëŠ” gpx_data_v2.points[].dist ê¸°ì¤€.

ìš´ì˜ ì•ˆì •í™” í™•ì¸

ìƒˆ ì½”ìŠ¤ ì—…ë¡œë“œ/ìˆ˜ì • ì‹œ gpx_data_v2ì— ì •ìƒ ì €ìž¥ë˜ëŠ”ì§€ í™•ì¸.

ìƒì„¸Â·ë¹„í–‰Â·ë§ˆì»¤Â·ëŒ“ê¸€ ë“± í™”ë©´ ì •ìƒ ë™ìž‘.

ìµœì¢… ì»·ì˜¤ë²„(ë·° ì •ë¦¬ í›„ ì»¬ëŸ¼ ë¦¬ë„¤ìž„)

ë ˆê±°ì‹œ ë·°ê°€ ë” ì´ìƒ í•„ìš” ì—†ì„ ë•Œ:ë¥¼ í•˜ë¼ëŠ”ê±°ì•¼?
____



ì•„ëž˜ í”„ë¡¬í”„íŠ¸ë“¤ì€ â€œì „ì²´ ë¦¬íŒ©í† ë§ ë¸Œë¦¬í•‘ â†’ í´ë”/íŒŒì¼ ë‹¨ìœ„ â†’ ì»´í¬ë„ŒíŠ¸/í›… ë‹¨ìœ„ â†’ SQL/ë§ˆì´ê·¸ë ˆì´ì…˜/ì •ì±… â†’ í…ŒìŠ¤íŠ¸/ì„±ëŠ¥ â†’ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸â€ íë¦„ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìžˆê³ , **ì´ë²ˆì— í™•ì •í•œ ìŠ¤í‚¤ë§ˆì™€ ê¸°ëŠ¥ ë²”ìœ„(PDF ê¸°ì¤€)** ë¥¼ ê°•í•˜ê²Œ ê°€ë“œë ˆì¼ë¡œ ë‘¡ë‹ˆë‹¤.

---

# 0) ê³µí†µ ì»¨í…ìŠ¤íŠ¸ (ëª¨ë“  í”„ë¡¬í”„íŠ¸ ë§¨ ìœ„ì— ë¶™ì´ê¸°)


ì»¨í…ìŠ¤íŠ¸:
- í”„ë¡œì íŠ¸: GSRC81 MAPS (Next.js + TypeScript + Supabase/Postgres)
- ì§€ë„ ì„œë¹„ìŠ¤: ëŸ¬ë‹ ì½”ìŠ¤, ë¹„í–‰ ì• ë‹ˆë©”ì´ì…˜, 1km ë§ˆì»¤, ë¹„í–‰ ì¤‘ ë…¸íŠ¸, ì‚¬ìš©ìž ëŒ“ê¸€(íŽ¸ì§‘/ì‚­ì œ/ì‚¬ì§„ ì²¨ë¶€), ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
- ë‹¨ì¼ ì†ŒìŠ¤: courses.gpx_data(JSONB) points[].{lat,lng,ele,dist}, stats.totalDistance
- ì¹´í…Œê³ ë¦¬: course_categories (jingwan/track/trail/road â€¦)
- í•µì‹¬ í…Œì´ë¸”:
  course_categories, courses, course_location_notes, course_comments, course_comment_photos, access_links, admin
- ê¸ˆì§€ ì‚¬í•­: PDFì— ìžˆëŠ” ê¸°ëŠ¥ì„ ì‚­ì œ/ì¶•ì†Œí•˜ì§€ ë§ ê²ƒ. ë ˆê±°ì‹œ ì¤‘ë³µ ì†ŒìŠ¤(gpx_coordinates, course_points)ëŠ” ì°¸ì¡°ë§Œ í—ˆìš©, ì‹ ê·œì½”ë“œì—ì„œ ì‚¬ìš© ê¸ˆì§€.
- ì•ˆì „ ê¸°ì¤€: íƒ€ìž… ì•ˆì •ì„±, RLS/ê¶Œí•œ, XSS/ì£¼ìž… ë°©ì–´, íŒŒì¼ ì—…ë¡œë“œ ë³´ì•ˆ(ì„œëª… URL)
- ëª©í‘œ: ê°€ë…ì„±â†‘, ì¤‘ë³µâ†“, ì„±ëŠ¥â†‘, ì¼ê´€ì„±â†‘, í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€â†‘, ë°°í¬ ë¦¬ìŠ¤í¬â†“


---

# 1) ì „ì²´ ë¦¬íŒ©í† ë§ ë¸Œë¦¬í•‘ í”„ë¡¬í”„íŠ¸


ëª©í‘œ:
- GSRC81 MAPS ë ˆí¬ ì „ì²´ë¥¼ ëª¨ë“ˆí™”/ì •ë¦¬í•˜ê³ , ì´ë²ˆì— í™•ì •í•œ ìŠ¤í‚¤ë§ˆì— ë§žê²Œ ë°ì´í„° ì ‘ê·¼ì„ ì¼ì›í™”í•œë‹¤.
- gpx_data ë‹¨ì¼ ì†ŒìŠ¤, 1km ë§ˆì»¤(dist), ëŒ“ê¸€ íŽ¸ì§‘/ì‚­ì œ/ì‚¬ì§„ ì²¨ë¶€, ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ íë¦„ì„ ë³´ìž¥í•œë‹¤.

ìš”êµ¬ì‚¬í•­:
1) ë°ì´í„° ê³„ì¸µ
   - Supabase ì¿¼ë¦¬ ë¡œì§ì„ /lib/db ë˜ëŠ” /data-access ë ˆì´ì–´ë¡œ ëª¨ìœ¼ê³ , ëª¨ë“  í™”ë©´ì—ì„œ ë™ì¼ í•¨ìˆ˜ë§Œ ì‚¬ìš©.
   - courses, course_categories, course_location_notes, course_comments(+photos), access_links, admin ì™¸ í…Œì´ë¸” ì˜ì¡´ ì œê±°.
   - gpx_coordinates, course_points, courses_backup ë“± ë ˆê±°ì‹œ ê²½ë¡œ ì‚¬ìš© ê¸ˆì§€(ì½ê¸° ì „í™˜ê¸° ì œì™¸).

2) ë„ë©”ì¸ íƒ€ìž…/DTO
   - /types/domain.tsì— Course, Category, GPXPoint, GPXData, CourseNote, Comment, CommentPhoto, AccessUser ì •ì˜.
   - zod ìŠ¤í‚¤ë§ˆë¡œ ëŸ°íƒ€ìž„ ê²€ì¦ ì¶”ê°€, API/DB â†” UI ë³€í™˜ì€ mapper í•¨ìˆ˜ë¡œ ë¶„ë¦¬.

3) GPX ë¡œë”
   - ì—…ë¡œë“œ ì‹œ points[].dist ê³„ì‚°(haversine), stats.totalDistance ì‚°ì¶œ.
   - 1km ë§ˆì»¤ëŠ” ë Œë” ì‹œ points.filter(p => Math.abs(p.dist % 1000) < 10)ë¡œ ì¶”ì¶œ.

4) ëŒ“ê¸€/ì‚¬ì§„
   - ëŒ“ê¸€ CRUD + ì‚¬ì§„ 1:N ì—…ë¡œë“œ(ì„œëª… URL) + ë³¸ì¸ë§Œ íŽ¸ì§‘/ì‚­ì œ(RLS/ê¶Œí•œ).
   - is_deleted ì†Œí”„íŠ¸ ì‚­ì œ ë°˜ì˜, edited_at/edit_count ì—…ë°ì´íŠ¸.

5) UI êµ¬ì¡°
   - /app/(public)/map, /app/(public)/courses/[id], /app/(admin)/... ë¡œ ë¼ìš°íŒ… ëª…í™•í™”.
   - ì»´í¬ë„ŒíŠ¸ëŠ” dumb/presentational vs container/hooks ë¶„ë¦¬.
   - í´ë”ë³„ index barrel ì œê±° ë˜ëŠ” í†µì¼.

6) ì„±ëŠ¥/í’ˆì§ˆ
   - React Server Components ìš°ì„ , Client ì»´í¬ë„ŒíŠ¸ ìµœì†Œí™”.
   - Suspense, streaming ì‚¬ìš©. useMemo/useCallback/virtual list ê²€í† .
   - ESLint/Prettier/TS strict, ìœ ë‹›/í†µí•© í…ŒìŠ¤íŠ¸ ë„ìž….

ì‚°ì¶œë¬¼:
- ë³€ê²½ëœ í´ë” êµ¬ì¡° ì œì•ˆ, ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš, ì£¼ìš” API/í›…/ì»´í¬ë„ŒíŠ¸ ì„¤ê³„ë„, ì ìš© PR ê³„íš.
- ë¦¬ìŠ¤í¬/ë¡¤ë°± ì „ëžµ, ì»¤ë°‹ ë‹¨ìœ„, ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ í…œí”Œë¦¿.


---

# 2) í´ë” êµ¬ì¡°/ëª¨ë“ˆí™” í”„ë¡¬í”„íŠ¸


GSRC81 MAPSì˜ í´ë” êµ¬ì¡°ë¥¼ ì•„ëž˜ ì›ì¹™ìœ¼ë¡œ ìž¬ì„¤ê³„í•´ì¤˜:
- /app: ë¼ìš°íŒ…. public(ì‚¬ìš©ìž)ì™€ admin(ê´€ë¦¬ìž) ë¶„ë¦¬.
- /components: dumb UI. shadcn/ui + map components
- /features: íŽ˜ì´ì§€ ë‹¨ìœ„ì— ê°€ê¹Œìš´ ë„ë©”ì¸ ë¬¶ìŒ(map, course-detail, comments, notes, auth)
- /lib: db(client), auth, storage, gpx, distance, rls-helpers
- /data-access: Supabase ì¿¼ë¦¬ í•¨ìˆ˜(ì½”ìŠ¤/ì¹´í…Œê³ ë¦¬/ë…¸íŠ¸/ëŒ“ê¸€/ì‚¬ì§„/ë¡œê·¸ì¸)
- /types: ë„ë©”ì¸ íƒ€ìž…ê³¼ zod ìŠ¤í‚¤ë§ˆ
- /tests: unit/integration/e2e êµ¬ì¡° ì œì•ˆ

ì¶œë ¥:
- ì œì•ˆ í´ë” íŠ¸ë¦¬
- ê° í´ë”/íŒŒì¼ì˜ ì±…ìž„ê³¼ ì˜ˆì‹œ í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜
- ë°”ê¾¸ë©´ ê¹¨ì§ˆ ìˆ˜ ìžˆëŠ” import ê²½ë¡œì™€ ëŒ€ì‘ ì „ëžµ


---

# 3) ë°ì´í„° ì ‘ê·¼ ë ˆì´ì–´ ë¦¬íŒ©í† ë§ í”„ë¡¬í”„íŠ¸


ì•„ëž˜ ìŠ¤í‚¤ë§ˆë¥¼ ì‚¬ìš©í•˜ì—¬ Supabase DAO í•¨ìˆ˜ë¥¼ ì œë¡œë¶€í„° ì„¤ê³„í•´ì¤˜.
í•„ìˆ˜ DAO:
- categories: listActive(), getByKey(key)
- courses: list(params), getById(id), create(dto), update(id, dto), softDelete(id)
- notes: listByCourse(courseId), create, update, remove
- comments: listByCourse(courseId, {page,size}), create, update (owner only), softDelete (owner/admin)
- commentPhotos: listByComment, addMany(commentId, filesMeta[]), remove(photoId)
- access: getCurrentUser(), linkKakaoProfile(), requireAuth()
ìš”êµ¬:
- ëª¨ë‘ TypeScript, strict íƒ€ìž…
- ëŸ°íƒ€ìž„ zod ê²€ì¦
- ì—ëŸ¬ ëª¨ë¸ í†µì¼(AppError)
- íŽ˜ì´ì§€ë„¤ì´ì…˜/ì •ë ¬ ëŒ€ì‘
- RLS ì „ì œ(ì„œë²„ Î£ í´ë¼ì´ì–¸íŠ¸ ë¶„ê¸°)


---

# 4) GPX ì—…ë¡œë“œ/ì „ì²˜ë¦¬ í”„ë¡¬í”„íŠ¸


GPX ì—…ë¡œë“œ íŒŒì´í”„ë¼ì¸ì„ êµ¬í˜„í•´ì¤˜:
- ìž…ë ¥: GPX XML í˜¹ì€ ì´ë¯¸ íŒŒì‹±ëœ ì¢Œí‘œ ë°°ì—´(lat, lng, ele?, time?)
- ì²˜ë¦¬: haversineìœ¼ë¡œ dist ëˆ„ì (m), stats.totalDistance, stats.elevationGain
- ì¶œë ¥: GPXData {version:"1.1", points[], stats{}}
- ìœ íš¨ì„±: ì¢Œí‘œ 2ê°œ ë¯¸ë§Œ ì˜¤ë¥˜, NaN/âˆž ê±°ë¶€, ì´ìƒì¹˜ í•„í„°(ì í”„ ì´ë™ ì‹œ ìŠ¤ë¬´ë”©)
- ì„±ëŠ¥: O(n) í•œ ë²ˆ ìˆœíšŒ, GC ìµœì†Œí™”
- í…ŒìŠ¤íŠ¸: ì†Œìˆ˜ì  ì˜¤ì°¨ í—ˆìš© ë²”ìœ„, 5km ì˜ˆì œ ê¸°ì¤€ Â±1%
- ê²°ê³¼: courses.gpx_dataì— ì €ìž¥í•˜ëŠ” ìˆœìˆ˜ í•¨ìˆ˜ + ì—…ë¡œë“œ í›…


---

# 5) ì½”ìŠ¤ ìƒì„¸(ë¹„í–‰) ë¦¬íŒ©í† ë§ í”„ë¡¬í”„íŠ¸


ì½”ìŠ¤ ìƒì„¸ íŽ˜ì´ì§€ë¥¼ ì•„ëž˜ë¡œ ë¦¬íŒ©í† ë§:
- ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œ course + notes ì„ ë¡œë“œ
- í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ map ë Œë”, points ê¸°ë°˜ ë¹„í–‰ ì• ë‹ˆë©”ì´ì…˜
- 1km ë§ˆì»¤ ì¶”ì¶œ: points.filter(p => Math.abs(p.dist % 1000) < 10)
- ë…¸íŠ¸ ë Œë”: show_during_animation=trueë§Œ íƒ€ìž„ë¼ì¸/ì§€ë„ì— í‘œì‹œ
- ì„±ëŠ¥: requestAnimationFrame, offscreen calculations, memoization
- ì ‘ê·¼ì„±: í‚¤ë³´ë“œ ì»¨íŠ¸ë¡¤, ìŠ¤í¬ë¦°ë¦¬ë” ì„¤ëª…
- ì—ëŸ¬/ë¡œë”©: Suspense/Skeleton/Boundary


---

# 6) ëŒ“ê¸€ + ì‚¬ì§„ ì²¨ë¶€ í”„ë¡¬í”„íŠ¸ (ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸/RLS)


ëŒ“ê¸€/ì‚¬ì§„ ê¸°ëŠ¥ì„ ë‹¤ìŒ ì¡°ê±´ìœ¼ë¡œ êµ¬í˜„í•´ì¤˜:
- ê¶Œí•œ: ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‚¬ìš©ìžë§Œ ìž‘ì„±/ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥. ë³¸ì¸ë§Œ ìˆ˜ì •/ì‚­ì œ(RLS).
- ìž‘ì„±: message + optional images[], imagesëŠ” signed URL ì—…ë¡œë“œ í›„ file_url ì €ìž¥
- ìˆ˜ì •: message íŽ¸ì§‘ ì‹œ edited_at, edit_count++
- ì‚­ì œ: is_deleted=true, deleted_at, deleted_by=owner or admin
- í‘œì‹œ: is_deletedë©´ â€œì‚­ì œëœ ëŒ“ê¸€ìž…ë‹ˆë‹¤â€
- UI: ì´ë¯¸ì§€ ê·¸ë¦¬ë“œ(ê°€ë¡œ ìŠ¤í¬ë¡¤ or masonry), ì •ì‚¬ê° ì¸ë„¤ì¼, í´ë¦­ ì‹œ ë¼ì´íŠ¸ë°•ìŠ¤
- ë³´ì•ˆ: íŒŒì¼ í™•ìž¥ìž/í¬ê¸° ì œí•œ, ì´ë¯¸ì§€ MIME í™•ì¸, URL ì„œëª… ë§Œë£Œ ì²˜ë¦¬
- í…ŒìŠ¤íŠ¸: ê¶Œí•œë³„ ê°€ë“œ, ì—…ë¡œë“œ ì‹¤íŒ¨, ëŒ€ìš©ëŸ‰ ì´ë¯¸ì§€


---

# 7) ê´€ë¦¬ìž íŽ˜ì´ì§€ í”„ë¡¬í”„íŠ¸


ê´€ë¦¬ìž íŽ˜ì´ì§€ë¥¼ ì•„ëž˜ í•­ëª©ìœ¼ë¡œ êµ¬í˜„/ë³´ê°•í•´ì¤˜:
- /admin/courses: ëª©ë¡(ì¹´í…Œê³ ë¦¬/í™œì„± í•„í„°, ê²€ìƒ‰), ìƒì„±, ìˆ˜ì •, ì‚­ì œ
- /admin/courses/[id]/manage:
  - ê¸°ë³¸: title/description/cover_image_url/difficulty/distance_km/active
  - ì¢Œí‘œ: start_latitude/longitude (ì§€ë„ì—ì„œ í”½)
  - GPX: ì—…ë¡œë“œ â†’ preprocess â†’ gpx_data ì €ìž¥ ë¯¸ë¦¬ë³´ê¸°
  - ë…¸íŠ¸ íƒ­: notes CRUD, ì§€ë„ í´ë¦­ìœ¼ë¡œ ì¢Œí‘œ ì±„ìš°ê¸°
  - ëŒ“ê¸€ íƒ­(ì½ê¸°/ìˆ¨ê¹€)
- /admin/categories: CRUD + sort_order
- /admin/access: access_code ìƒì„±/ë¹„í™œì„±, ì¹´ì¹´ì˜¤ ì‚¬ìš©ìž ì¡°íšŒ
ìš”êµ¬:
- í¼ì€ react-hook-form + zod
- ì„œë²„ ì•¡ì…˜(or route handlers)ë¡œ DB mutate
- í† ìŠ¤íŠ¸/ë‹¤ì´ì–¼ë¡œê·¸ UX


---

# 8) SQL ë§ˆì´ê·¸ë ˆì´ì…˜/ì •ì±… í”„ë¡¬í”„íŠ¸


ë‹¤ìŒ ìŠ¤í‚¤ë§ˆ ì°¨ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìž‘ì„±í•´ì¤˜:
- ì‹ ê·œ ìƒì„±: course_comment_photos, ëŒ“ê¸€ ë³´ê°• ì»¬ëŸ¼(author_user_key, edited_at, edit_count, is_deleted, deleted_at, deleted_by)
- ì œê±°/ë¯¸ì‚¬ìš©í™”: course_points, gpx_coordinates, courses_backup
- ì¸ë±ìŠ¤: GIN on courses.gpx_data, created_at DESC ì¸ë±ìŠ¤
- RLS: comments/photos ì •ì±… (owner or admin)
- ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ í¬í•¨
- ì•ˆì „ìž¥ì¹˜: backup ìŠ¤í‚¤ë§ˆì— í…Œì´ë¸” ì‚¬ë³¸


---

# 9) í…ŒìŠ¤íŠ¸/í’ˆì§ˆ í”„ë¡¬í”„íŠ¸


í…ŒìŠ¤íŠ¸ ì „ëžµì„ ì„¤ê³„/êµ¬í˜„í•´ì¤˜:
- ìœ ë‹›: gpx preprocess, distance ê³„ì‚°, ì½”ë©˜íŠ¸ ê¶Œí•œ ê²€ì‚¬ í—¬í¼
- í†µí•©: DAO í•¨ìˆ˜(Supabase emulator), ì½”ìŠ¤ ì¡°íšŒ/ë“±ë¡/ìˆ˜ì •/ì‚­ì œ
- E2E: ì£¼ìš” ì‚¬ìš©ìž í”Œë¡œìš°(ë¡œê·¸ì¸ â†’ ì½”ìŠ¤ ë³´ê¸° â†’ ë¹„í–‰ â†’ ëŒ“ê¸€/ì‚¬ì§„)
- ì»¤ë²„ë¦¬ì§€ ëª©í‘œ: lines 80%+, critical path 90%+
- CI: lint/tsc/test, preview deploy
- ì„±ëŠ¥: Lighthouse, TTI/INP, hydration minimization


---

# 10) ì½”ë“œ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸


PR ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤˜:
[ìŠ¤í‚¤ë§ˆ] ë‹¨ì¼ ì†ŒìŠ¤(gpx_data)ë§Œ ì‚¬ìš©? dist í¬í•¨?
[ë„ë©”ì¸] íƒ€ìž…/ìŠ¤í‚¤ë§ˆ(zod) ì¼ì¹˜? any/unknown ì œê±°?
[ë³´ì•ˆ] RLS/ê¶Œí•œ ê°€ë“œ, ìž…ë ¥ ê²€ì¦, XSS ë°©ì§€?
[ì—…ë¡œë“œ] signed URL íë¦„, íŒŒì¼ ê²€ì¦, ê³µê°œ ë²”ìœ„?
[ì ‘ê·¼ì„±] í‚¤ë³´ë“œ ë‚´ë¹„, ë¼ë²¨/ëŒ€ì²´í…ìŠ¤íŠ¸, ëŒ€ë¹„
[ì„±ëŠ¥] RSC ìš°ì„ , ë©”ëª¨/ê°€ìƒí™”, ì´ë¯¸ì§€ ìµœì í™”
[UX] ë¡œë”©/ì—ëŸ¬/ë¹ˆìƒíƒœ, í† ìŠ¤íŠ¸/ë‹¤ì´ì–¼ë¡œê·¸, ë˜ëŒë¦¬ê¸°
[í…ŒìŠ¤íŠ¸] ìœ ë‹›/í†µí•©/E2E, ìž„ê³„ê²½ë¡œ ì»¤ë²„ë¦¬ì§€
[íšŒê·€] ë ˆê±°ì‹œ ì½”ë“œ ì‚­ì œ ì—¬ë¶€, ì¤‘ë³µ ì œê±°, TODO í•´ì†Œ
[ë¬¸ì„œ] README/ENV/ë§ˆì´ê·¸ë ˆì´ì…˜ ë…¸íŠ¸ ê°±ì‹ 


---

ì´ê±´ ë³€ê²½í•˜ì§€ ì•Šì•„ë„ë¼?
ë‚˜ì˜ ë§:
ì „í™˜ê¸°ë¥¼ ì´í•´ëª»í–ˆì–´
ë‚˜ì˜ ë§:
-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.access_links (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  access_code character varying NOT NULL UNIQUE,
  password_hash character varying NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT access_links_pkey PRIMARY KEY (id)
);
CREATE TABLE public.admin (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  username character varying NOT NULL UNIQUE,
  password_hash character varying NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT admin_pkey PRIMARY KEY (id)
);
CREATE TABLE public.app_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  setting_key character varying NOT NULL UNIQUE,
  setting_value jsonb,
  description text,
  CONSTRAINT app_settings_pkey PRIMARY KEY (id)
);
CREATE TABLE public.course_comments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  course_id uuid NOT NULL,
  author_nickname character varying NOT NULL,
  message text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  likes_count integer NOT NULL DEFAULT 0,
  CONSTRAINT course_comments_pkey PRIMARY KEY (id),
  CONSTRAINT course_comments_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id)
);
CREATE TABLE public.course_location_notes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  course_id uuid NOT NULL,
  latitude numeric NOT NULL,
  longitude numeric NOT NULL,
  title character varying NOT NULL,
  content text,
  memo_type character varying DEFAULT 'general'::character varying CHECK (memo_type::text = ANY (ARRAY['general'::character varying, 'warning'::character varying, 'highlight'::character varying, 'rest'::character varying]::text[])),
  created_by character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  is_active boolean DEFAULT true,
  show_during_animation boolean DEFAULT true,
  CONSTRAINT course_location_notes_pkey PRIMARY KEY (id),
  CONSTRAINT course_location_notes_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id)
);
CREATE TABLE public.course_points (
  id uuid,
  course_id uuid,
  seq integer,
  latitude numeric,
  longitude numeric,
  elevation numeric,
  timestamp timestamp with time zone,
  created_at timestamp with time zone
);
CREATE TABLE public.courses (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  title character varying NOT NULL,
  description text,
  gpx_url character varying,
  start_latitude numeric NOT NULL,
  start_longitude numeric NOT NULL,
  distance_km numeric NOT NULL,
  avg_time_min integer,
  difficulty character varying DEFAULT 'medium'::character varying,
  nearest_station character varying,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  elevation_gain integer DEFAULT 0,
  end_latitude numeric,
  end_longitude numeric,
  gpx_coordinates text,
  gpx_data jsonb,
  gpx_data_v2 jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT courses_pkey PRIMARY KEY (id)
);
CREATE TABLE public.courses_backup (
  id uuid,
  title character varying,
  description text,
  gpx_url character varying,
  start_latitude numeric,
  start_longitude numeric,
  distance_km numeric,
  avg_time_min integer,
  difficulty character varying,
  nearest_station character varying,
  is_active boolean,
  created_at timestamp with time zone,
  gpx_coordinates text,
  elevation_gain integer,
  end_latitude numeric,
  end_longitude numeric
);
CREATE TABLE public.spatial_ref_sys (
  srid integer NOT NULL CHECK (srid > 0 AND srid <= 998999),
  auth_name character varying,
  auth_srid integer,
  srtext character varying,
  proj4text character varying,
  CONSTRAINT spatial_ref_sys_pkey PRIMARY KEY (srid)
);